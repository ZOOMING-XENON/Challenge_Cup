{% extends "base.html" %}

{% block title %}上网审计管控 - 企业安全管理系统{% endblock %}

{% block extra_style %}
.main-content {
    margin-left: var(--sidebar-width);
    padding: 20px;
    padding-top: 80px;
}

.monitor-card {
    margin-bottom: 20px;
    transition: transform 0.2s ease;
}

.monitor-card:hover {
    transform: translateY(-2px);
}

.monitor-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--color-fg-default);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.monitor-badge {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 12px;
    background: var(--color-canvas-subtle);
    color: var(--color-fg-muted);
}

.monitor-list {
    max-height: 300px;
    overflow-y: auto;
    border-radius: 6px;
}

.monitor-list::-webkit-scrollbar {
    width: 6px;
}

.monitor-list::-webkit-scrollbar-thumb {
    background-color: var(--color-border-default);
    border-radius: 3px;
}

.monitor-item {
    padding: 12px;
    border-bottom: 1px solid var(--color-border-default);
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background-color 0.2s ease;
}

.monitor-item:hover {
    background-color: var(--color-canvas-subtle);
}

.monitor-item:last-child {
    border-bottom: none;
}

.monitor-icon {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: white;
    transition: transform 0.2s ease;
}

.monitor-item:hover .monitor-icon {
    transform: scale(1.1);
}

.monitor-info {
    flex: 1;
}

.monitor-time {
    color: var(--color-fg-muted);
    font-size: 14px;
    display: flex;
    align-items: center;
}

.monitor-time i {
    margin-right: 5px;
    font-size: 12px;
}

.monitor-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
    display: inline-block;
}

.status-active {
    background-color: var(--color-success-emphasis);
    box-shadow: 0 0 0 3px rgba(45, 164, 78, 0.2);
}

.status-warning {
    background-color: var(--github-warning);
    box-shadow: 0 0 0 3px rgba(191, 135, 0, 0.2);
}

.new-item {
    opacity: 1;
    transform: none;
    animation: none;
}

/* 添加弹窗样式 */
.detail-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    position: relative;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--color-border-default);
}

.modal-close {
    cursor: pointer;
    padding: 5px;
    font-size: 20px;
    color: var(--color-fg-muted);
}

.modal-close:hover {
    color: var(--color-danger-fg);
}

.detail-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.detail-item {
    padding: 12px;
    border-bottom: 1px solid var(--color-border-default);
    display: flex;
    align-items: center;
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-icon {
    margin-right: 15px;
    color: var(--color-fg-muted);
}

.detail-time {
    margin-left: auto;
    color: var(--color-fg-muted);
    font-size: 14px;
}

.monitor-item {
    cursor: pointer;
}

/* 添加历史记录表格样式 */
.history-table {
    width: 100%;
    border-collapse: collapse;
}

.history-table th,
.history-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid var(--color-border-default);
}

.history-table th {
    background-color: var(--color-canvas-subtle);
    font-weight: 600;
}

.history-table tr:hover {
    background-color: var(--color-canvas-subtle);
}
{% endblock %}

{% block content %}
<!-- 侧边栏 -->
<div class="sidebar">
    <div class="system-title">
        <i class="fas fa-shield-alt"></i>
        企业安全管理系统
    </div>
    <nav class="nav flex-column">
        <a class="nav-link" href="/overview"><i class="fas fa-tachometer-alt"></i> 概览</a>
        <a class="nav-link" href="/admin"><i class="fas fa-users"></i> 员工管理</a>
        <a class="nav-link active" href="/monitor"><i class="fas fa-globe"></i> 上网审计管控</a>
        <a class="nav-link" href="#"><i class="fas fa-database"></i> 数据备份与监测</a>
        <a class="nav-link" href="#"><i class="fas fa-chart-line"></i> 行为分析</a>
        <a class="nav-link" href="#"><i class="fas fa-lock"></i> 勒索防护</a>
        <a class="nav-link" href="#"><i class="fas fa-cog"></i> 软件管理</a>
    </nav>
</div>

<!-- 顶部导航栏 -->
<div class="top-nav">
    <div class="d-flex align-items-center">
        <i class="fas fa-bars me-3"></i>
        <span>上网审计管控</span>
    </div>
    <div class="d-flex align-items-center">
        <span class="me-3"><i class="fas fa-bell"></i></span>
        <span class="me-3"><i class="fas fa-user"></i> 管理员</span>
        <a href="/logout" class="btn btn-outline-secondary btn-sm">退出</a>
    </div>
</div>

<!-- 主要内容区域 -->
<div class="main-content">
    <div class="row">
        <!-- 活动窗口监控 -->
        <div class="col-md-6">
            <div class="card monitor-card">
                <div class="card-body">
                    <h5 class="monitor-title">
                        <div>
                            <i class="fas fa-window-maximize me-2"></i>活动窗口监控
                        </div>
                        <span class="monitor-badge">
                            <i class="fas fa-clock me-1"></i>实时更新
                        </span>
                    </h5>
                    <div class="monitor-list" id="activeWindowList">
                        <!-- 动态内容 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 微信文件监控 -->
        <div class="col-md-6">
            <div class="card monitor-card">
                <div class="card-body">
                    <h5 class="monitor-title">
                        <div>
                            <i class="fab fa-weixin me-2"></i>微信文件监控
                        </div>
                        <span class="monitor-badge" id="fileCount">
                            <i class="fas fa-file me-1"></i>0 个文件
                        </span>
                    </h5>
                    <div class="monitor-list" id="wechatFileList">
                        <!-- 动态内容 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 已安装软件 -->
        <div class="col-md-12">
            <div class="card monitor-card">
                <div class="card-body">
                    <h5 class="monitor-title">
                        <div>
                            <i class="fas fa-laptop me-2"></i>已安装软件
                        </div>
                        <span class="monitor-badge" id="softwareCount">
                            <i class="fas fa-cube me-1"></i>0 个应用
                        </span>
                    </h5>
                    <div class="monitor-list" id="installedSoftwareList">
                        <!-- 动态内容 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加微信文件历史记录卡片 -->
        <div class="col-md-12 mt-4">
            <div class="card monitor-card">
                <div class="card-body">
                    <h5 class="monitor-title">
                        <div>
                            <i class="fab fa-weixin me-2"></i>微信文件传输历史记录
                        </div>
                        <span class="monitor-badge" id="historyCount">
                            <i class="fas fa-history me-1"></i>24小时内记录
                        </span>
                    </h5>
                    <div class="table-responsive">
                        <table class="history-table" id="fileHistoryTable">
                            <thead>
                                <tr>
                                    <th>文件名</th>
                                    <th>首次发现时间</th>
                                    <th>最后发现时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 动态内容 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加弹窗 -->
<div id="detailModal" class="detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="modalTitle"></h5>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let previousData = {
    active_window: '',
    wechat_files: [],
    installed_software: [],
    active_window_history: [],
    wechat_files_details: {},
    software_details: {}
};

function updateMonitorData() {
    fetch('/get_latest_data')
        .then(response => response.json())
        .then(data => {
            // 更新活动窗口
            if (data.active_window !== previousData.active_window) {
                const activeWindowList = document.getElementById('activeWindowList');
                activeWindowList.innerHTML = `
                    <div class="monitor-item new-item" onclick="showDetails('window')">
                        <div class="d-flex align-items-center">
                            <div class="monitor-icon bg-primary">
                                <i class="fas fa-window-maximize"></i>
                            </div>
                            <div class="monitor-info">
                                <div>${data.active_window}</div>
                                <div class="monitor-time">
                                    <span class="monitor-status status-active"></span>
                                    当前活动
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 更新微信文件列表
            const wechatFileList = document.getElementById('wechatFileList');
            document.getElementById('fileCount').innerHTML = `
                <i class="fas fa-file me-1"></i>${data.wechat_files.length} 个文件
            `;
            
            const newFilesList = data.wechat_files.map((file, index) => `
                <div class="monitor-item ${!previousData.wechat_files.includes(file) ? 'new-item' : ''}" 
                     onclick="showDetails('file', '${file}')">
                    <div class="d-flex align-items-center">
                        <div class="monitor-icon bg-success">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="monitor-info">
                            <div>${file}</div>
                            <div class="monitor-time">
                                <i class="fas fa-clock"></i>
                                最近更新
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            wechatFileList.innerHTML = newFilesList;

            // 更新已安装软件列表
            const installedSoftwareList = document.getElementById('installedSoftwareList');
            document.getElementById('softwareCount').innerHTML = `
                <i class="fas fa-cube me-1"></i>${data.installed_software.length} 个应用
            `;
            
            const newSoftwareList = data.installed_software.map((software, index) => `
                <div class="monitor-item ${!previousData.installed_software.includes(software) ? 'new-item' : ''}" 
                     onclick="showDetails('software', '${software}')">
                    <div class="d-flex align-items-center">
                        <div class="monitor-icon bg-info">
                            <i class="fas fa-cube"></i>
                        </div>
                        <div class="monitor-info">
                            <div>${software}</div>
                            <div class="monitor-time">
                                <i class="fas fa-check-circle"></i>
                                已安装
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            installedSoftwareList.innerHTML = newSoftwareList;

            // 更新历史记录表格
            const historyTableBody = document.querySelector('#fileHistoryTable tbody');
            const historyEntries = Object.entries(data.wechat_files_history || {});
            
            historyTableBody.innerHTML = historyEntries
                .sort((a, b) => new Date(b[1].last_seen) - new Date(a[1].last_seen))
                .map(([filename, details]) => `
                    <tr>
                        <td><i class="fas fa-file me-2"></i>${filename}</td>
                        <td>${details.first_seen}</td>
                        <td>${details.last_seen}</td>
                    </tr>
                `).join('');

            // 更新历史记录数量
            document.getElementById('historyCount').innerHTML = `
                <i class="fas fa-history me-1"></i>${historyEntries.length} 条记录
            `;

            // 存储详细信息
            previousData.active_window_history = data.active_window_history || [];
            previousData.wechat_files_details = data.wechat_files_details || {};
            previousData.software_details = data.software_details || {};
        });
}

function showDetails(type, item) {
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    let content = '';

    switch(type) {
        case 'window':
            modalTitle.innerHTML = '<i class="fas fa-window-maximize me-2"></i>活动窗口历史';
            content = `
                <ul class="detail-list">
                    ${previousData.active_window_history.map(record => `
                        <li class="detail-item">
                            <i class="fas fa-window-maximize detail-icon"></i>
                            <span>${record.title}</span>
                            <span class="detail-time">${record.time}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
            break;

        case 'file':
            const fileDetails = previousData.wechat_files_details[item] || {};
            modalTitle.innerHTML = '<i class="fab fa-weixin me-2"></i>文件详细信息';
            content = `
                <ul class="detail-list">
                    <li class="detail-item">
                        <i class="fas fa-file detail-icon"></i>
                        <div>
                            <div><strong>文件名：</strong> ${item}</div>
                            <div><strong>大小：</strong> ${fileDetails.size || 'N/A'}</div>
                            <div><strong>修改时间：</strong> ${fileDetails.modified_time || 'N/A'}</div>
                            <div><strong>路径：</strong> ${fileDetails.path || 'N/A'}</div>
                        </div>
                    </li>
                </ul>
            `;
            break;

        case 'software':
            const softwareDetails = previousData.software_details[item] || {};
            modalTitle.innerHTML = '<i class="fas fa-cube me-2"></i>软件详细信息';
            content = `
                <ul class="detail-list">
                    <li class="detail-item">
                        <i class="fas fa-cube detail-icon"></i>
                        <div>
                            <div><strong>软件名：</strong> ${item}</div>
                            <div><strong>版本：</strong> ${softwareDetails.version || 'N/A'}</div>
                            <div><strong>安装时间：</strong> ${softwareDetails.install_time || 'N/A'}</div>
                            <div><strong>发布者：</strong> ${softwareDetails.publisher || 'N/A'}</div>
                            <div><strong>安装路径：</strong> ${softwareDetails.install_path || 'N/A'}</div>
                        </div>
                    </li>
                </ul>
            `;
            break;
    }

    modalContent.innerHTML = content;
    modal.style.display = 'block';
}

function closeModal() {
    document.getElementById('detailModal').style.display = 'none';
}

// 点击空白处关闭弹窗
window.onclick = function(event) {
    const modal = document.getElementById('detailModal');
    if (event.target === modal) {
        closeModal();
    }
}

// 页面加载时立即更新一次
updateMonitorData();

// 每3秒更新一次数据
setInterval(updateMonitorData, 3000);
</script>
{% endblock %} 